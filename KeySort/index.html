<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å„¿æ­ŒéŸ³å¾‹å¸ˆ - å„¿æ­Œæ—‹å¾‹å¡«ç©ºæŒ‘æˆ˜</title>
    
    <!-- æ¸¸æˆå›¾æ ‡ -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8IS0tIOiDjOaZr+iDjOaZryAtLT4KICA8cmVjdCB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHJ4PSI2IiBmaWxsPSIjNjY3ZWVhIi8+CiAgCiAgPCEtLSDpkoljoo7pm75rZXlzIC0tPgogIDxyZWN0IHg9IjQiIHk9IjIwIiB3aWR0aD0iMyIgaGVpZ2h0PSI4IiBmaWxsPSJ3aGl0ZSIvPgogIDxyZWN0IHg9IjgiIHk9IjIwIiB3aWR0aD0iMyIgaGVpZ2h0PSI4IiBmaWxsPSJibGFjayIvPgogIDxyZWN0IHg9IjEyIiB5PSIyMCIgd2lkdGg9IjMiIGhlaWdodD0iOCIgZmlsbD0id2hpdGUiLz4KICA8cmVjdCB4PSIxNiIgeT0iMjAiIHdpZHRoPSIzIiBoZWlnaHQ9IjgiIGZpbGw9ImJsYWNrIi8+CiAgPHJlY3QgeD0iMjAiIHk9IjIwIiB3aWR0aD0iMyIgaGVpZ2h0PSI4IiBmaWxsPSJ3aGl0ZSIvPgogIDxyZWN0IHg9IjI0IiB5PSIyMCIgd2lkdGg9IjMiIGhlaWdodD0iOCIgZmlsbD0iYmxhY2siLz4KICA8cmVjdCB4PSIyOCIgeT0iMjAiIHdpZHRoPSIzIiBoZWlnaHQ9IjgiIGZpbGw9IndoaXRlIi8+CiAgCiAgPCEtLSDpn7PnrKYgLS0+CiAgPGNpcmNsZSBjeD0iMTAiIGN5PSIxMCIgcj0iMyIgZmlsbD0iIzFFRjZGRiIvPgogIDxlbGxpcHNlIGN4PSIxNCIgY3k9IjYiIHJ4PSIyLjUiIHJ5PSIxLjUiIGZpbGw9IiMxRUY2RkYiLz4KICA8Y2lyY2xlIGN4PSIyMiIgY3k9IjgiIHI9IjIuNSIgZmlsbD0iI0ZGRkYwMCIvPgogIDxlbGxpcHNlIGN4PSIyNiIgY3k9IjEyIiByeD0iMiIgcnk9IjEuNSIgZmlsbD0iI0ZGRkYwMCIvPgo8L3N2Zz4K">
    <link rel="shortcut icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8IS0tIOiDjOaZr+iDjOaZryAtLT4KICA8cmVjdCB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHJ4PSI2IiBmaWxsPSIjNjY3ZWVhIi8+CiAgCiAgPCEtLSDpkoljoo7pm75rZXlzIC0tPgogIDxyZWN0IHg9IjQiIHk9IjIwIiB3aWR0aD0iMyIgaGVpZ2h0PSI4IiBmaWxsPSJ3aGl0ZSIvPgogIDxyZWN0IHg9IjgiIHk9IjIwIiB3aWR0aD0iMyIgaGVpZ2h0PSI4IiBmaWxsPSJibGFjayIvPgogIDxyZWN0IHg9IjEyIiB5PSIyMCIgd2lkdGg9IjMiIGhlaWdodD0iOCIgZmlsbD0id2hpdGUiLz4KICA8cmVjdCB4PSIxNiIgeT0iMjAiIHdpZHRoPSIzIiBoZWlnaHQ9IjgiIGZpbGw9ImJsYWNrIi8+CiAgPHJlY3QgeD0iMjAiIHk9IjIwIiB3aWR0aD0iMyIgaGVpZ2h0PSI4IiBmaWxsPSJ3aGl0ZSIvPgogIDxyZWN0IHg9IjI0IiB5PSIyMCIgd2lkdGg9IjMiIGhlaWdodD0iOCIgZmlsbD0iYmxhY2siLz4KICA8cmVjdCB4PSIyOCIgeT0iMjAiIHdpZHRoPSIzIiBoZWlnaHQ9IjgiIGZpbGw9IndoaXRlIi8+CiAgCiAgPCEtLSDpn7PnrKYgLS0+CiAgPGNpcmNsZSBjeD0iMTAiIGN5PSIxMCIgcj0iMyIgZmlsbD0iIzFFRjZGRiIvPgogIDxlbGxpcHNlIGN4PSIxNCIgY3k9IjYiIHJ4PSIyLjUiIHJ5PSIxLjUiIGZpbGw9IiMxRUY2RkYiLz4KICA8Y2lyY2xlIGN4PSIyMiIgY3k9IjgiIHI9IjIuNSIgZmlsbD0iI0ZGRkYwMCIvPgogIDxlbGxpcHNlIGN4PSIyNiIgY3k9IjEyIiByeD0iMiIgcnk9IjEuNSIgZmlsbD0iI0ZGRkYwMCIvPgo8L3N2Zz4K">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            color: white;
        }

        .game-container {
            max-width: 1200px;
            width: 100%;
            text-align: center;
        }

        .header {
            margin-bottom: 30px;
        }

        .title {
            font-size: 2.5em;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .game-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255,255,255,0.1);
            padding: 15px 25px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            margin-bottom: 30px;
        }

        .level-info, .song-info, .timer-info, .score-info {
            font-size: 1.2em;
            font-weight: bold;
        }

        .song-info {
            color: #ffc107;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .game-area {
            background: rgba(255,255,255,0.15);
            border-radius: 20px;
            padding: 40px;
            backdrop-filter: blur(15px);
            margin-bottom: 30px;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .instructions {
            font-size: 1em;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            max-width: 800px;
            text-align: left;
            line-height: 1.5;
        }

        .instructions h3 {
            font-size: 1.1em;
            font-weight: bold;
        }

        .instructions p {
            font-size: 0.95em;
            opacity: 0.9;
        }

        .piano-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin: 30px 0;
            min-height: 150px;
            align-items: center;
            padding: 15px;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .piano-container.drag-over {
            background: rgba(76, 175, 80, 0.1);
            border: 2px dashed #4CAF50;
            transform: scale(1.02);
        }

        .piano-key {
            width: 80px;
            height: 120px;
            background: linear-gradient(to bottom, #ffffff, #f0f0f0);
            border: 3px solid #333;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px;
            font-weight: bold;
            font-size: 16px;
            color: #333;
            transition: all 0.2s ease;
            user-select: none;
            position: relative;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .piano-key:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
        }

        .piano-key.active, .ref-note.active {
            transform: translateY(3px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            background: linear-gradient(to bottom, #f0f0f0, #e0e0e0);
        }

        .ref-note.active {
            background: rgba(76, 175, 80, 0.5) !important;
            transform: scale(1.05);
        }

        .piano-key.dragging {
            opacity: 0.8;
            transform: rotate(5deg);
            z-index: 1000;
        }

        .drop-zone {
            width: 100%;
            min-height: 150px;
            border: 3px dashed rgba(255,255,255,0.5);
            border-radius: 15px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 15px;
            padding: 20px;
            margin: 20px 0;
            background: rgba(255,255,255,0.05);
        }

        .drop-zone.drag-over {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
        }

        .blank-position.drag-over .blank-slot {
            background: rgba(76, 175, 80, 0.3) !important;
            border-color: #4CAF50 !important;
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.5);
        }

        .filled-note.dragging {
            opacity: 0.8;
            transform: scale(1.1) rotate(3deg);
            z-index: 1000;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(45deg, #2196F3, #1976D2);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(45deg, #f44336, #d32f2f);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(45deg, #ff9800, #f57c00);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            color: #333;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .modal h2 {
            margin-bottom: 20px;
            color: #333;
        }

        .leaderboard {
            text-align: left;
            margin: 20px 0;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .celebration {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3em;
            z-index: 1500;
            animation: celebrate 2s ease-in-out;
        }

        @keyframes celebrate {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.5); }
        }

        @media (max-width: 768px) {
            .game-info {
                flex-direction: column;
                gap: 10px;
            }
            
            .piano-key {
                width: 60px;
                height: 90px;
                font-size: 14px;
            }
            
            .title {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="header">
            <h1 class="title">ğŸ¹ğŸµ å„¿æ­ŒéŸ³å¾‹å¸ˆ ğŸ¶âœ¨</h1>
            <p style="font-size: 1.2em; margin-bottom: 15px; opacity: 0.9;">å„¿æ­Œæ—‹å¾‹å¡«ç©ºæŒ‘æˆ˜</p>
            <div class="game-info">
                <div class="level-info">å…³å¡: <span id="current-level">1</span>/5</div>
                <div class="song-info">â™ª <span id="current-song">å°æ˜Ÿæ˜Ÿ</span></div>
                <div class="timer-info">æ—¶é—´: <span id="timer">00:00</span></div>
                <div class="score-info">é”®ä½æ•°é‡: <span id="key-count">3</span></div>
            </div>
            
            <div class="lyrics-panel" style="
                background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
                border: 2px solid #4CAF50;
                border-radius: 15px;
                padding: 15px;
                margin: 15px 0;
                text-align: center;
                box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            ">
                <h4 style="color: #2196F3; margin: 0 0 10px 0; font-size: 16px;">ğŸµ å½“å‰æ®µè½æ­Œè¯</h4>
                <div id="lyrics-display" style="
                    font-size: 18px;
                    line-height: 1.6;
                    color: #333;
                    font-weight: 500;
                    letter-spacing: 1px;
                ">
                    [æ­Œè¯å°†åœ¨æ­¤æ˜¾ç¤º]
                </div>
            </div>
        </div>

        <div class="game-area">
            <div class="instructions">
                <h3 style="margin-bottom: 15px; color: #fff;">ğŸµ æ¸¸æˆç›®æ ‡</h3>
                <p style="margin-bottom: 10px;">é€šè¿‡å¬è§‰è¯†åˆ«é’¢ç´é”®çš„éŸ³é«˜ï¼Œå°†å®ƒä»¬æŒ‰ä»ä½åˆ°é«˜çš„é¡ºåºæ­£ç¡®æ’åˆ—</p>
                
                <h3 style="margin-bottom: 10px; margin-top: 15px; color: #fff;">ğŸ® æ“ä½œè¯´æ˜</h3>
                <p style="margin-bottom: 8px;">â€¢ ç‚¹å‡»é’¢ç´é”®è¯•å¬éŸ³é«˜</p>
                <p style="margin-bottom: 8px;">â€¢ æ‹–æ‹½é’¢ç´é”®åˆ°ä¸‹æ–¹æ’åºåŒºåŸŸ</p>
                <p style="margin-bottom: 8px;">â€¢ ä»æ’åºåŒºåŸŸæ‹–å‡ºå³å¯è¿”å›ä¸Šæ–¹</p>
                <p style="margin-bottom: 8px;">â€¢ ä½¿ç”¨"æ’­æ”¾æ’åº"è¯•å¬å½“å‰é¡ºåº</p>
                
                <h3 style="margin-bottom: 10px; margin-top: 15px; color: #fff;">âœ¨ æ¸¸æˆç‰¹è‰²</h3>
                <p style="margin-bottom: 8px;">â€¢ 5å…³é€’è¿›æŒ‘æˆ˜ï¼Œä»ç®€å•åˆ°å¤æ‚çš„å„¿æ­Œç‰‡æ®µ</p>
                <p style="margin-bottom: 8px;">â€¢ æ¯å…³éŸ³é«˜ç‹¬ä¸€æ— äºŒï¼Œæå‡è¾¨éŸ³èƒ½åŠ›</p>
                <p style="margin-bottom: 8px;">â€¢ å®æ—¶è®¡æ—¶æ’è¡Œæ¦œï¼ŒæŒ‘æˆ˜ä¸ªäººæé™</p>
                <p style="margin-bottom: 8px;">â€¢ ä¸“ä¸šéŸ³æ„Ÿè®­ç»ƒï¼Œé€‚åˆéŸ³ä¹å­¦ä¹ è€…</p>
            </div>
            
            <div class="piano-container" id="piano-container">
                <!-- é’¢ç´é”®å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <div class="controls">
                <button class="btn btn-warning" id="hint-btn">ğŸ’¡ æç¤º</button>
                <button class="btn btn-primary" id="check-btn">æ£€æŸ¥ç­”æ¡ˆ</button>
                <button class="btn btn-danger" id="restart-btn">é‡æ–°å¼€å§‹</button>
            </div>
        </div>
    </div>

    <!-- æ¸¸æˆå®Œæˆæ¨¡æ€æ¡† -->
    <div class="modal" id="game-complete-modal">
        <div class="modal-content">
            <h2>ğŸ‰ æ­å–œé€šå…³ï¼</h2>
            <p>æ‚¨å®Œæˆäº†æ‰€æœ‰5å…³ï¼</p>
            <p>æ€»ç”¨æ—¶: <span id="final-time"></span></p>
            <div class="leaderboard" id="leaderboard">
                <h3>æ’è¡Œæ¦œ:</h3>
            </div>
            <button class="btn btn-primary" onclick="startNewGame()">é‡æ–°æŒ‘æˆ˜</button>
        </div>
    </div>

    <!-- å…³å¡å®Œæˆæ¨¡æ€æ¡† -->
    <div class="modal" id="level-complete-modal">
        <div class="modal-content">
            <h2>ğŸŠ å…³å¡å®Œæˆï¼</h2>
            <p>å‡†å¤‡è¿›å…¥ä¸‹ä¸€å…³</p>
            <button class="btn btn-primary" onclick="nextLevel()">ä¸‹ä¸€å…³</button>
        </div>
    </div>

    <!-- åº†ç¥åŠ¨ç”» -->
    <div class="celebration" id="celebration">ğŸ‰</div>

    <script>
        class PianoSortGame {
            constructor() {
                this.currentLevel = 1;
                this.maxLevel = 5;
                this.startTime = null;
                this.gameRunning = false;
                this.audioContext = null;
                this.currentKeys = [];
                this.currentSong = null;
                this.blankPositions = [];
                this.songs = this.initSongDatabase();
                
                // è®©æ¸¸æˆå®ä¾‹å¯ä»¥å…¨å±€è®¿é—®
                window.game = this;
                
                this.initAudio();
                this.bindEvents();
                this.startNewGame();
            }

            initSongDatabase() {
                return [
                    {
                        name: "å°æ˜Ÿæ˜Ÿ",
                        melody: [1, 1, 5, 5, 6, 6, 5, 0, 4, 4, 3, 3, 2, 2, 1],
                        lyrics: ["do", "do", "sol", "sol", "la", "la", "sol", "ä¼‘", "fa", "fa", "mi", "mi", "re", "re", "do"],
                        displayLyrics: "ä¸€é—ªä¸€é—ªäº®æ™¶æ™¶ï¼Œæ»¡å¤©éƒ½æ˜¯å°æ˜Ÿæ˜Ÿ"
                    },
                    {
                        name: "ç”Ÿæ—¥å¿«ä¹",
                        melody: [
                            {note: 5, octave: -1}, {note: 5, octave: -1}, {note: 6, octave: -1}, {note: 5, octave: -1}, 
                            {note: 1, octave: 0}, {note: 7, octave: -1}, 0, 
                            {note: 5, octave: -1}, {note: 5, octave: -1}, {note: 6, octave: -1}, {note: 5, octave: -1}, 
                            {note: 2, octave: 0}, {note: 1, octave: 0}
                        ],
                        lyrics: ["solÌ±", "solÌ±", "laÌ±", "solÌ±", "do", "ti", "ä¼‘", "sol", "sol", "la", "sol", "re", "do"],
                        displayLyrics: "ç¥ä½ ç”Ÿæ—¥å¿«ä¹ï¼Œç¥ä½ ç”Ÿæ—¥å¿«ä¹"
                    },
                    {
                        name: "ä¸¤åªè€è™",
                        melody: [1, 2, 3, 1, 0, 1, 2, 3, 1, 0, 3, 4, 5, 0, 3, 4, 5, 0, 5, 6, 5, 4, 3, 1, 0, 5, 6, 5, 4, 3, 1],
                                                 lyrics: ["do", "re", "mi", "do", "ä¼‘", "do", "re", "mi", "do", "ä¼‘", "mi", "fa", "sol", "ä¼‘", "mi", "fa", "sol", "ä¼‘", "sol", "la", "sol", "fa", "mi", "do", "ä¼‘", "sol", "la", "sol", "fa", "mi", "do"],
                        displayLyrics: "ä¸¤åªè€è™ï¼Œä¸¤åªè€è™ï¼Œè·‘å¾—å¿«ï¼Œè·‘å¾—å¿«"
                    },
                    {
                        name: "å°æ¯›é©´",
                        melody: [{note: 1, octave: 0},{note: 1, octave: 0},{note: 1, octave: 0},{note: 3, octave: 0}, {note: 5, octave: 0},{note: 5, octave: 0},{note: 5, octave: 0},{note: 5, octave: 0},{note: 6, octave: 0},{note: 6, octave: 0},{note: 6, octave: 0},{note: 1, octave: 1},{note: 5, octave: 0},0,
                        {note: 4, octave: 0},{note: 4, octave: 0},{note: 4, octave: 0},{note: 6, octave: 0}, {note: 3, octave: 0},{note: 3, octave: 0},{note: 3, octave: 0},{note: 3, octave: 0},{note: 2, octave: 0},{note: 2, octave: 0},{note: 2, octave: 0},{note: 2, octave: 0},{note: 5, octave: 0},
                        ],
                        lyrics: ["do", "do", "do", "mi", "sol", "sol", "sol", "sol", "la", "la", "la", "do", "sol","ä¼‘", "fa", "fa", "fa", "la", "mi", "mi", "mi", "mi", "re", "re", "re", "re", "soá¸»"],
                        displayLyrics: "æˆ‘æœ‰ä¸€ä¸ªå°æ¯›é©´æˆ‘ä»æ¥ä¹Ÿä¸éª‘ï¼Œæœ‰ä¸€å¤©æˆ‘å¿ƒè¡€æ¥æ½®éª‘ç€å»èµ¶é›†"
                    },
                    {
                        name: "æ‹”èåœ",
                        melody: [{note: 5, octave: -1},{note: 6, octave: -1},1,0,3,2,1,0,5,5,5,5,0,1,2,1,0,5,5,5,5,0,1,2,1,0,5,5,1,0,5,5,1,0,5,5,5,3,2,0,1,2,1],
                                                 lyrics: ["soá¸»", "laÌ±", "do", "ä¼‘", "mi", "re", "do", "ä¼‘", "sol", "sol", "sol", "sol", "ä¼‘", "do", "re", "do", "ä¼‘", "sol", "sol", "sol", "sol", "ä¼‘", "do", "re", "do", "ä¼‘", "sol", "sol", "do", "ä¼‘", "sol", "sol", "do", "ä¼‘", "sol", "sol", "sol", "mi", "re", "ä¼‘", "do", "re", "do"],
                        displayLyrics: "æ‹”èåœï¼Œæ‹”èåœï¼Œå˜¿å’»å˜¿å’»ï¼Œæ‹”èåœï¼Œå˜¿å’»å˜¿å’»æ‹”ä¸åŠ¨ï¼Œå°é»„ç‹—ï¼Œå¿«å¿«æ¥ï¼Œå¿«æ¥å¸®æˆ‘ä»¬æ‹”èåœ"
                    }
                ];
            }

            async initAudio() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    console.log('AudioContext created, state:', this.audioContext.state);
                } catch (error) {
                    console.warn('Web Audio API not supported:', error);
                }
            }

            async ensureAudioContext() {
                if (!this.audioContext) {
                    await this.initAudio();
                }
                
                if (this.audioContext && this.audioContext.state === 'suspended') {
                    console.log('Resuming AudioContext...');
                    await this.audioContext.resume();
                    console.log('AudioContext resumed, state:', this.audioContext.state);
                }
            }



            bindEvents() {
                document.getElementById('check-btn').addEventListener('click', () => this.checkOrder());
                document.getElementById('restart-btn').addEventListener('click', () => this.startNewGame());
                document.getElementById('hint-btn').addEventListener('click', () => this.playHintMelody());
                
                // æ‹–æ‹½äº‹ä»¶
                document.addEventListener('dragstart', (e) => this.handleDragStart(e));
                document.addEventListener('dragover', (e) => this.handleDragOver(e));
                document.addEventListener('drop', (e) => this.handleDrop(e));
                document.addEventListener('dragend', (e) => this.handleDragEnd(e));
            }

            // å°†ç®€è°±æ•°å­—è½¬æ¢ä¸ºé¢‘ç‡ (Cå¤§è°ƒï¼Œæ”¯æŒé«˜ä½éŸ³)
            noteToFrequency(noteData) {
                // æ”¯æŒä¼ å…¥æ•°å­—æˆ–å¯¹è±¡æ ¼å¼
                let note, octave = 0;
                if (typeof noteData === 'object' && noteData !== null) {
                    note = noteData.note;
                    octave = noteData.octave || 0;
                } else {
                    note = noteData;
                    octave = 0;
                }
                
                const baseFreq = 261.63; // C4 (do)
                const noteMap = {
                    1: 0,   // do (C)
                    2: 2,   // re (D)
                    3: 4,   // mi (E)
                    4: 5,   // fa (F)
                    5: 7,   // sol (G)
                    6: 9,   // la (A)
                    7: 11   // ti (B)
                };
                
                const semitones = noteMap[note];
                if (semitones === undefined) {
                    console.warn('Invalid note:', note);
                    return 261.63; // é»˜è®¤è¿”å›C4
                }
                
                // åŠ ä¸Šå…«åº¦åç§»ï¼š-1è¡¨ç¤ºä½å…«åº¦ï¼Œ0è¡¨ç¤ºæ ‡å‡†å…«åº¦ï¼Œ1è¡¨ç¤ºé«˜å…«åº¦
                const frequency = baseFreq * Math.pow(2, (semitones + octave * 12) / 12);
                return frequency;
            }

            startNewGame() {
                this.currentLevel = 1;
                this.startTime = Date.now();
                this.gameRunning = true;
                this.updateTimer();
                this.generateLevel();
            }

            generateLevel() {
                const currentSong = this.songs[this.currentLevel - 1];
                const melody = currentSong.melody;
                
                // è®¡ç®—éœ€è¦ç©ºç¼ºçš„éŸ³ç¬¦æ•°é‡ï¼ˆçº¦30%ï¼‰
                const blankCount = Math.max(2, Math.round(melody.length * 0.3));
                
                // éšæœºé€‰æ‹©ç©ºç¼ºä½ç½®
                this.generateBlankPositions(melody.length, blankCount);
                
                document.getElementById('current-level').textContent = this.currentLevel;
                document.getElementById('current-song').textContent = currentSong.name;
                document.getElementById('key-count').textContent = blankCount;
                
                // æ˜¾ç¤ºå½“å‰å„¿æ­Œä¿¡æ¯å’Œæ—‹å¾‹
                this.displaySongInfo(currentSong);
                
                // æ›´æ–°æ­Œè¯æ˜¾ç¤ºé¢æ¿
                this.updateLyricsDisplay(currentSong);
                
                // ç”Ÿæˆéœ€è¦å¡«ç©ºçš„é’¢ç´é”®
                this.generateKeys(currentSong);
                this.resetMelodyDisplay();
                
                // åˆå§‹åŒ–æŒ‰é’®çŠ¶æ€
                document.getElementById('check-btn').disabled = false;
            }

            updateLyricsDisplay(song) {
                const lyricsDisplay = document.getElementById('lyrics-display');
                lyricsDisplay.textContent = song.displayLyrics;
            }

            generateBlankPositions(melodyLength, blankCount) {
                const currentSong = this.songs[this.currentLevel - 1];
                
                // è¿‡æ»¤æ‰ä¼‘æ­¢ç¬¦ä½ç½®ï¼ˆmelody[i] === 0ï¼‰
                const validPositions = [];
                for (let i = 0; i < melodyLength; i++) {
                    if (currentSong.melody[i] !== 0) {
                        validPositions.push(i);
                    }
                }
                
                // ç¡®ä¿æœ‰è¶³å¤Ÿçš„éä¼‘æ­¢ç¬¦ä½ç½®å¯ä¾›é€‰æ‹©
                const maxBlankCount = Math.min(blankCount, Math.floor(validPositions.length * 0.6));
                
                // éšæœºé€‰æ‹©ç©ºç¼ºä½ç½®ï¼ˆåªä»éä¼‘æ­¢ç¬¦ä½ç½®ä¸­é€‰æ‹©ï¼‰
                this.blankPositions = [];
                const availablePositions = [...validPositions];
                
                for (let i = 0; i < maxBlankCount; i++) {
                    const randomIndex = Math.floor(Math.random() * availablePositions.length);
                    this.blankPositions.push(availablePositions[randomIndex]);
                    availablePositions.splice(randomIndex, 1);
                }
                
                // æ’åºç©ºç¼ºä½ç½®
                this.blankPositions.sort((a, b) => a - b);
                
                console.log('æœ‰æ•ˆä½ç½®:', validPositions);
                console.log('ç©ºç¼ºä½ç½®:', this.blankPositions);
            }

            displaySongInfo(song) {
                // åœ¨instructionåŒºåŸŸæ˜¾ç¤ºå®Œæ•´æ—‹å¾‹å’Œä»»åŠ¡è¯´æ˜
                const instructionDiv = document.querySelector('.instructions');
                instructionDiv.innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #4CAF50; margin-bottom: 10px;">ğŸµ å®Œæ•´æ—‹å¾‹ï¼ˆç©ºç¼ºä½ç½®éœ€è¦å¡«è¡¥ï¼‰ï¼š</h4>
                        <div id="melody-display" style="display: flex; gap: 8px; justify-content: center; margin-bottom: 15px; flex-wrap: wrap;">
                            <!-- æ—‹å¾‹æ˜¾ç¤ºå°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                        <button onclick="window.game.playCompleteMelody()" style="
                            padding: 8px 16px; 
                            background: #4CAF50; 
                            color: white; 
                            border: none; 
                            border-radius: 15px; 
                            cursor: pointer;
                            font-size: 14px;
                        ">æ’­æ”¾å®Œæ•´æ—‹å¾‹</button>
                    </div>
                    <div>
                        <h4 style="color: #FF9800; margin-bottom: 10px;">ä»»åŠ¡ï¼šå¡«è¡¥ç©ºç¼ºéŸ³ç¬¦</h4>
                        <p style="opacity: 0.9; font-size: 0.9em;">å°†ä¸‹æ–¹çš„éŸ³ç¬¦æ‹–æ‹½åˆ°æ—‹å¾‹ä¸­çš„ç©ºç¼ºä½ç½®</p>
                        <p style="opacity: 0.8; font-size: 0.85em;">éœ€è¦å¡«è¡¥ ${this.blankPositions.length} ä¸ªç©ºç¼ºä½ç½®ï¼ˆçº¦30%ï¼‰</p>
                    </div>
                `;
                
                // ç”Ÿæˆæ—‹å¾‹æ˜¾ç¤º
                this.generateMelodyDisplay(song);
            }

            generateMelodyDisplay(song) {
                const melodyDisplay = document.getElementById('melody-display');
                melodyDisplay.innerHTML = '';
                
                song.melody.forEach((note, index) => {
                    const noteDiv = document.createElement('div');
                    noteDiv.className = 'melody-note';
                    
                    if (note === 0) {
                        // ä¼‘æ­¢ç¬¦ä½ç½®
                        noteDiv.innerHTML = `
                            <div class="rest-note" style="
                                width: 60px;
                                height: 80px;
                                border: 2px solid #9C27B0;
                                border-radius: 8px;
                                display: flex;
                                flex-direction: column;
                                align-items: center;
                                justify-content: center;
                                background: rgba(156, 39, 176, 0.1);
                                color: #9C27B0;
                                font-weight: bold;
                                text-align: center;
                                line-height: 1.2;
                            ">
                                <div style="font-size: 24px;">â™ª</div>
                                <div style="font-size: 10px; opacity: 0.9;">ä¼‘æ­¢</div>
                            </div>
                        `;
                    } else if (this.blankPositions.includes(index)) {
                        // ç©ºç¼ºä½ç½®
                        noteDiv.classList.add('blank-position');
                        noteDiv.dataset.position = index;
                        noteDiv.innerHTML = `
                            <div class="blank-slot" style="
                                width: 60px;
                                height: 80px;
                                border: 3px dashed #ff9800;
                                border-radius: 8px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                background: rgba(255, 152, 0, 0.1);
                                color: #ff9800;
                                font-size: 12px;
                                text-align: center;
                            ">
                                ?<br/>ç©ºç¼º
                            </div>
                        `;
                    } else {
                        // å·²çŸ¥éŸ³ç¬¦ - å¤„ç†é«˜ä½éŸ³æ˜¾ç¤º
                        const noteValue = typeof note === 'object' ? note.note : note;
                        const octave = typeof note === 'object' ? note.octave || 0 : 0;
                        
                        // ç”Ÿæˆå…«åº¦æ ‡è¯†
                        let octaveDisplay = '';
                        if (octave === -1) {
                            octaveDisplay = '<div style="font-size: 8px; color: #ff5722;">â—</div>'; // ä½éŸ³ç‚¹
                        } else if (octave === 1) {
                            octaveDisplay = '<div style="font-size: 8px; color: #ff5722;">â—</div>'; // é«˜éŸ³ç‚¹
                        }
                        
                        const melodyNoteElement = document.createElement('div');
                        melodyNoteElement.className = 'melody-note-filled';
                        melodyNoteElement.style.cssText = `
                            width: 60px;
                            height: 80px;
                            background: linear-gradient(to bottom, #e3f2fd, #bbdefb);
                            border: 2px solid #2196f3;
                            border-radius: 8px;
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            justify-content: center;
                            font-weight: bold;
                            cursor: pointer;
                            position: relative;
                        `;
                        
                        melodyNoteElement.innerHTML = `
                            ${octave === 1 ? octaveDisplay : ''}
                            <div style="font-size: 16px;">${noteValue}</div>
                            <div style="font-size: 10px; opacity: 0.8;">${song.lyrics[index]}</div>
                            ${octave === -1 ? octaveDisplay : ''}
                        `;
                        
                        melodyNoteElement.addEventListener('click', () => {
                            this.playNote(note);
                            melodyNoteElement.style.transform = 'scale(0.95)';
                            setTimeout(() => melodyNoteElement.style.transform = 'scale(1)', 150);
                        });
                        
                        noteDiv.appendChild(melodyNoteElement);
                    }
                    
                    melodyDisplay.appendChild(noteDiv);
                });
            }

            generateKeys(song) {
                const container = document.getElementById('piano-container');
                container.innerHTML = '';
                
                this.currentKeys = [];
                this.currentSong = song;
                
                // åŸºäºç©ºç¼ºä½ç½®ç”Ÿæˆéœ€è¦å¡«ç©ºçš„é’¢ç´é”®
                const blankNotes = this.blankPositions.map(pos => ({
                    note: song.melody[pos],
                    lyric: song.lyrics[pos],
                    originalPosition: pos
                }));
                
                // æ‰“ä¹±ç©ºç¼ºéŸ³ç¬¦çš„é¡ºåº
                const shuffledBlankNotes = this.shuffleArray([...blankNotes]);
                
                shuffledBlankNotes.forEach((noteInfo, displayIndex) => {
                    const frequency = this.noteToFrequency(noteInfo.note);
                    
                    const key = this.createPianoKey(frequency, displayIndex, noteInfo.originalPosition, noteInfo.note, noteInfo.lyric);
                    container.appendChild(key);
                    this.currentKeys.push(key);
                });
                
                console.log('å½“å‰å„¿æ­Œ:', song.name);
                console.log('ç©ºç¼ºéŸ³ç¬¦:', blankNotes);
                console.log('æ‰“ä¹±å:', shuffledBlankNotes);
            }

            createPianoKey(frequency, displayIndex, correctIndex, noteData, lyric) {
                const key = document.createElement('div');
                key.className = 'piano-key';
                key.draggable = true;
                key.dataset.frequency = frequency;
                key.dataset.index = displayIndex;
                key.dataset.correctIndex = correctIndex;
                key.dataset.keyData = JSON.stringify({
                    note: noteData,
                    lyric: lyric,
                    index: displayIndex,
                    correctIndex: correctIndex
                });
                
                // å¤„ç†é«˜ä½éŸ³æ˜¾ç¤º
                const noteValue = typeof noteData === 'object' ? noteData.note : noteData;
                const octave = typeof noteData === 'object' ? noteData.octave || 0 : 0;
                
                // ç”Ÿæˆå…«åº¦æ ‡è¯†å’ŒèƒŒæ™¯è‰²
                let octaveIndicator = '';
                let backgroundColor = '';
                if (octave === -1) {
                    octaveIndicator = 'Ì±'; // ä¸‹åˆ’çº¿è¡¨ç¤ºä½éŸ³
                    backgroundColor = 'background: linear-gradient(to bottom, #ffebee, #ffcdd2); border: 2px solid #f44336;';
                } else if (octave === 1) {
                    octaveIndicator = 'Ì‡'; // ä¸Šåˆ’çº¿è¡¨ç¤ºé«˜éŸ³
                    backgroundColor = 'background: linear-gradient(to bottom, #e8f5e8, #c8e6c9); border: 2px solid #4caf50;';
                } else {
                    backgroundColor = 'background: linear-gradient(to bottom, #fff3e0, #ffe0b2); border: 2px solid #ff9800;';
                }
                
                key.style.cssText = `
                    width: 80px;
                    height: 120px;
                    margin: 5px;
                    border-radius: 8px;
                    ${backgroundColor}
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    cursor: pointer;
                    user-select: none;
                    transition: all 0.2s ease;
                    position: relative;
                `;
                
                key.innerHTML = `
                    <div style="font-size: 20px; font-weight: bold; margin-bottom: 5px;">
                        ${noteValue}${octaveIndicator}
                        ${octave === -1 ? '<div style="position: absolute; bottom: -2px; left: 50%; transform: translateX(-50%); width: 8px; height: 2px; background: #f44336; border-radius: 1px;"></div>' : ''}
                        ${octave === 1 ? '<div style="position: absolute; top: -2px; left: 50%; transform: translateX(-50%); width: 8px; height: 2px; background: #4caf50; border-radius: 1px;"></div>' : ''}
                    </div>
                    <div style="font-size: 12px; opacity: 0.8;">${lyric}</div>
                `;
                
                key.addEventListener('click', () => {
                    this.playNote(noteData);
                    key.classList.add('active');
                    setTimeout(() => key.classList.remove('active'), 200);
                });
                
                return key;
            }

            async playNote(noteDataOrFrequency) {
                try {
                    await this.ensureAudioContext();
                    if (!this.audioContext) return;
                    
                    // åˆ¤æ–­ä¼ å…¥çš„æ˜¯é¢‘ç‡è¿˜æ˜¯éŸ³ç¬¦æ•°æ®
                    let frequency;
                    if (typeof noteDataOrFrequency === 'number' && noteDataOrFrequency > 50) {
                        // å¤§äº50çš„æ•°å­—è®¤ä¸ºæ˜¯é¢‘ç‡ (éŸ³ç¬¦é¢‘ç‡é€šå¸¸åœ¨80Hzä»¥ä¸Š)
                        frequency = noteDataOrFrequency;
                    } else {
                        // å…¶ä»–æƒ…å†µéƒ½å½“ä½œéŸ³ç¬¦æ•°æ®å¤„ç†
                        frequency = this.noteToFrequency(noteDataOrFrequency);
                    }
                    
                    if (frequency < 20 || frequency > 20000) {
                        console.warn('Frequency out of audible range:', frequency);
                        return;
                    }
                    
                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(this.audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(frequency, this.audioContext.currentTime);
                    oscillator.type = 'sine';
                    
                    gainNode.gain.setValueAtTime(0.3, this.audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.8);
                    
                    oscillator.start(this.audioContext.currentTime);
                    oscillator.stop(this.audioContext.currentTime + 0.8);
                } catch (error) {
                    console.error('Error playing note:', error);
                }
            }

            playReferenceSequence() {
                if (!this.audioContext || !this.currentSong) return;
                
                this.currentSong.reference.forEach((note, index) => {
                    setTimeout(() => {
                        const frequency = this.noteToFrequency(note);
                        this.playNote(frequency);
                        
                        // é«˜äº®å‚è€ƒåºåˆ—ä¸­çš„å¯¹åº”éŸ³ç¬¦
                        const refNotes = document.querySelectorAll('.ref-note');
                        if (refNotes[index]) {
                            refNotes[index].classList.add('active');
                            setTimeout(() => refNotes[index].classList.remove('active'), 200);
                        }
                    }, index * 600);
                });
            }

            playCompleteMelody() {
                if (!this.audioContext || !this.currentSong) return;
                
                let playIndex = 0;
                
                // éå†æ—‹å¾‹ï¼Œæ’­æ”¾åˆ°ç¬¬ä¸€ä¸ªæœªå¡«å……çš„ç©ºç¼ºä½ç½®åœæ­¢
                for (let index = 0; index < this.currentSong.melody.length; index++) {
                    const note = this.currentSong.melody[index];
                    
                    if (note === 0) {
                        // ä¼‘æ­¢ç¬¦ï¼Œè·³è¿‡æ’­æ”¾ä½†ä¿æŒæ—¶é—´é—´éš”
                        setTimeout(() => {
                            // é«˜äº®ä¼‘æ­¢ç¬¦
                            const restNotes = document.querySelectorAll('.rest-note');
                            restNotes.forEach(restElement => {
                                const parentNote = restElement.closest('.melody-note');
                                if (parentNote && Array.from(parentNote.parentNode.children).indexOf(parentNote) === index) {
                                    restElement.style.transform = 'scale(0.95)';
                                    setTimeout(() => restElement.style.transform = 'scale(1)', 200);
                                }
                            });
                        }, playIndex * 600);
                        playIndex++;
                    } else if (this.blankPositions.includes(index)) {
                        // æ˜¯ç©ºç¼ºä½ç½®ï¼Œæ£€æŸ¥æ˜¯å¦å·²å¡«å……
                        const blankSlot = document.querySelector(`.blank-position[data-position="${index}"]`);
                        const filledNote = blankSlot?.querySelector('.filled-note');
                        
                        if (filledNote) {
                            // å·²å¡«å……ï¼Œæ’­æ”¾å¡«å……çš„éŸ³ç¬¦
                            const keyData = JSON.parse(filledNote.dataset.keyData);
                            setTimeout(() => {
                                const frequency = this.noteToFrequency(keyData.note);
                                this.playNote(frequency);
                                
                                // é«˜äº®å·²å¡«å……çš„éŸ³ç¬¦
                                filledNote.style.transform = 'scale(0.95)';
                                setTimeout(() => filledNote.style.transform = 'scale(1)', 200);
                            }, playIndex * 600);
                            playIndex++;
                        } else {
                            // æœªå¡«å……ï¼Œåœæ­¢æ’­æ”¾
                            console.log(`æ’­æ”¾åœ¨ä½ç½® ${index} åœæ­¢ï¼ˆç©ºç¼ºæœªå¡«å……ï¼‰`);
                            break;
                        }
                    } else {
                        // å·²çŸ¥éŸ³ç¬¦ï¼Œæ­£å¸¸æ’­æ”¾
                        setTimeout(() => {
                            const frequency = this.noteToFrequency(note);
                            this.playNote(frequency);
                            
                            // é«˜äº®å¯¹åº”çš„æ—‹å¾‹éŸ³ç¬¦
                            const melodyNotes = document.querySelectorAll('.melody-note-filled');
                            melodyNotes.forEach(noteElement => {
                                const parentNote = noteElement.closest('.melody-note');
                                if (parentNote && Array.from(parentNote.parentNode.children).indexOf(parentNote) === index) {
                                    noteElement.style.transform = 'scale(0.95)';
                                    setTimeout(() => noteElement.style.transform = 'scale(1)', 200);
                                }
                            });
                        }, playIndex * 600);
                        playIndex++;
                    }
                }
            }

            playHintMelody() {
                if (!this.audioContext || !this.currentSong) return;
                
                // æ’­æ”¾å®Œæ•´çš„æ­£ç¡®æ—‹å¾‹ï¼ŒåŒ…æ‹¬ç©ºç¼ºä½ç½®çš„æ­£ç¡®éŸ³ç¬¦
                let playIndex = 0;
                this.currentSong.melody.forEach((note, index) => {
                    if (note === 0) {
                        // ä¼‘æ­¢ç¬¦ï¼Œè·³è¿‡æ’­æ”¾ä½†ä¿æŒæ—¶é—´é—´éš”
                        setTimeout(() => {
                            // é«˜äº®ä¼‘æ­¢ç¬¦
                            const restNotes = document.querySelectorAll('.rest-note');
                            restNotes.forEach(restElement => {
                                const parentNote = restElement.closest('.melody-note');
                                if (parentNote && Array.from(parentNote.parentNode.children).indexOf(parentNote) === index) {
                                    restElement.style.transform = 'scale(0.95)';
                                    setTimeout(() => restElement.style.transform = 'scale(1)', 200);
                                }
                            });
                        }, playIndex * 600);
                        playIndex++;
                    } else {
                        // æ­£å¸¸éŸ³ç¬¦
                        setTimeout(() => {
                            const frequency = this.noteToFrequency(note);
                            this.playNote(frequency);
                        }, playIndex * 600);
                        playIndex++;
                    }
                });
                
                // æ˜¾ç¤ºæç¤ºä¿¡æ¯
                setTimeout(() => {
                    alert('ğŸ’¡ è¿™å°±æ˜¯å®Œæ•´çš„æ­£ç¡®æ—‹å¾‹ï¼\nè¯·ä»”ç»†å¬ç©ºç¼ºä½ç½®çš„éŸ³ç¬¦ï¼Œç„¶åè¿›è¡Œå¡«è¡¥ã€‚\næ³¨æ„å¥é—´çš„åœé¡¿ï¼');
                }, (playIndex + 1) * 600);
            }

            shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

            handleDragStart(e) {
                if (e.target.classList.contains('piano-key')) {
                    e.target.classList.add('dragging');
                    const keyData = JSON.parse(e.target.dataset.keyData);
                    e.dataTransfer.setData('text/plain', JSON.stringify(keyData));
                } else if (e.target.classList.contains('filled-note')) {
                    e.target.classList.add('dragging');
                    const keyData = JSON.parse(e.target.dataset.keyData);
                    e.dataTransfer.setData('text/plain', JSON.stringify({
                        ...keyData,
                        isFromBlank: true,
                        sourceBlankPosition: e.target.closest('.blank-position').dataset.position
                    }));
                }
            }

            handleDragOver(e) {
                e.preventDefault();
                
                const blankSlot = e.target.closest('.blank-position');
                const pianoContainer = e.target.closest('.piano-container');
                
                if (blankSlot) {
                    blankSlot.classList.add('drag-over');
                    // ç§»é™¤å…¶ä»–ä½ç½®çš„é«˜äº®
                    document.querySelectorAll('.blank-position.drag-over').forEach(slot => {
                        if (slot !== blankSlot) slot.classList.remove('drag-over');
                    });
                    // ç§»é™¤é’¢ç´å®¹å™¨çš„é«˜äº®
                    document.getElementById('piano-container').classList.remove('drag-over');
                } else if (pianoContainer) {
                    // æ‹–æ‹½åˆ°é’¢ç´é”®åŒºåŸŸï¼Œç”¨äºä»ç©ºç¼ºä½ç½®æ‹–å‡º
                    pianoContainer.classList.add('drag-over');
                    // ç§»é™¤ç©ºç¼ºä½ç½®çš„é«˜äº®
                    document.querySelectorAll('.blank-position').forEach(slot => {
                        slot.classList.remove('drag-over');
                    });
                } else {
                    // æ¸…é™¤æ‰€æœ‰é«˜äº®
                    document.querySelectorAll('.blank-position').forEach(slot => {
                        slot.classList.remove('drag-over');
                    });
                    document.getElementById('piano-container').classList.remove('drag-over');
                }
            }

            handleDrop(e) {
                e.preventDefault();
                
                try {
                    const dragData = JSON.parse(e.dataTransfer.getData('text/plain'));
                    const blankSlot = e.target.closest('.blank-position');
                    
                    if (blankSlot) {
                        // æ‹–æ‹½åˆ°ç©ºç¼ºä½ç½®
                        const position = parseInt(blankSlot.dataset.position);
                        
                        if (dragData.isFromBlank) {
                            // ä»å…¶ä»–ç©ºç¼ºä½ç½®æ‹–æ¥çš„éŸ³ç¬¦
                            const sourceBlankSlot = document.querySelector(`.blank-position[data-position="${dragData.sourceBlankPosition}"]`);
                            const sourceFilledNote = sourceBlankSlot?.querySelector('.filled-note');
                            
                            // æ£€æŸ¥ç›®æ ‡ä½ç½®æ˜¯å¦å·²æœ‰éŸ³ç¬¦
                            const existingNote = blankSlot.querySelector('.filled-note');
                            if (existingNote) {
                                // äº¤æ¢ä¸¤ä¸ªä½ç½®çš„éŸ³ç¬¦
                                const existingKeyData = JSON.parse(existingNote.dataset.keyData);
                                
                                // å…ˆæ¸…é™¤ä¸¤ä¸ªä½ç½®
                                sourceFilledNote?.remove();
                                existingNote.remove();
                                
                                // é‡æ–°å¡«å……
                                this.fillBlankPosition(blankSlot, dragData);
                                this.fillBlankPosition(sourceBlankSlot, existingKeyData);
                            } else {
                                // ç§»åŠ¨åˆ°ç©ºçš„ä½ç½®
                                sourceFilledNote?.remove();
                                this.fillBlankPosition(blankSlot, dragData);
                                this.clearBlankPosition(sourceBlankSlot);
                            }
                        } else {
                            // ä»é’¢ç´é”®åŒºåŸŸæ‹–æ¥çš„éŸ³ç¬¦
                            const draggedKey = this.currentKeys[dragData.index];
                            
                            // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰éŸ³ç¬¦åœ¨è¿™ä¸ªä½ç½®
                            const existingNote = blankSlot.querySelector('.filled-note');
                            if (existingNote) {
                                // å°†å·²æœ‰éŸ³ç¬¦ç§»å›é’¢ç´é”®åŒºåŸŸ
                                const returnedKeyData = JSON.parse(existingNote.dataset.keyData);
                                this.returnKeyToPiano(returnedKeyData);
                                existingNote.remove();
                            }
                            
                            // å°†éŸ³ç¬¦æ”¾å…¥ç©ºç¼ºä½ç½®
                            this.fillBlankPosition(blankSlot, dragData);
                            
                            // éšè—åŸå§‹é’¢ç´é”®
                            draggedKey.style.opacity = '0.3';
                            draggedKey.style.pointerEvents = 'none';
                        }
                        
                        this.updateFilledPositions();
                    } else {
                        // æ‹–æ‹½åˆ°ç©ºç¼ºä½ç½®å¤–
                        const pianoContainer = e.target.closest('.piano-container');
                        
                        if (dragData.isFromBlank && pianoContainer) {
                            // ä»ç©ºç¼ºä½ç½®æ‹–åˆ°é’¢ç´é”®åŒºåŸŸï¼Œæ¢å¤éŸ³ç¬¦
                            const sourceBlankSlot = document.querySelector(`.blank-position[data-position="${dragData.sourceBlankPosition}"]`);
                            const sourceFilledNote = sourceBlankSlot?.querySelector('.filled-note');
                            
                            if (sourceFilledNote) {
                                // æ¢å¤åŸå§‹é’¢ç´é”®
                                this.returnKeyToPiano(dragData);
                                
                                // æ¸…é™¤ç©ºç¼ºä½ç½®
                                sourceFilledNote.remove();
                                this.clearBlankPosition(sourceBlankSlot);
                                
                                this.updateFilledPositions();
                            }
                        }
                    }
                } catch (error) {
                    console.error('æ‹–æ‹½å¤„ç†é”™è¯¯:', error);
                }
                
                // æ¸…é™¤æ‰€æœ‰æ‹–æ‹½æ ·å¼
                document.querySelectorAll('.blank-position').forEach(slot => {
                    slot.classList.remove('drag-over');
                });
                document.getElementById('piano-container').classList.remove('drag-over');
            }

            clearBlankPosition(blankSlot) {
                blankSlot.innerHTML = `
                    <div class="blank-slot" style="
                        width: 60px;
                        height: 80px;
                        border: 3px dashed #ff9800;
                        border-radius: 8px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        background: rgba(255, 152, 0, 0.1);
                        color: #ff9800;
                        font-size: 12px;
                        text-align: center;
                    ">
                        ?<br/>ç©ºç¼º
                    </div>
                `;
            }

            handleDragEnd(e) {
                if (e.target.classList.contains('piano-key')) {
                    e.target.classList.remove('dragging');
                }
                if (e.target.classList.contains('filled-note')) {
                    e.target.classList.remove('dragging');
                }
                
                // æ¸…é™¤æ‰€æœ‰æ‹–æ‹½æ ·å¼
                document.querySelectorAll('.blank-position').forEach(slot => {
                    slot.classList.remove('drag-over');
                });
                document.getElementById('piano-container').classList.remove('drag-over');
            }

            fillBlankPosition(blankSlot, keyData) {
                // å¤„ç†é«˜ä½éŸ³æ˜¾ç¤º
                const noteValue = typeof keyData.note === 'object' ? keyData.note.note : keyData.note;
                const octave = typeof keyData.note === 'object' ? keyData.note.octave || 0 : 0;
                
                // ç”Ÿæˆå…«åº¦æ ‡è¯†å’ŒèƒŒæ™¯è‰²
                let octaveIndicator = '';
                let backgroundColor = '';
                if (octave === -1) {
                    octaveIndicator = 'Ì±'; // ä¸‹åˆ’çº¿è¡¨ç¤ºä½éŸ³
                    backgroundColor = 'background: linear-gradient(to bottom, #ffebee, #ffcdd2); border: 2px solid #f44336;';
                } else if (octave === 1) {
                    octaveIndicator = 'Ì‡'; // ä¸Šåˆ’çº¿è¡¨ç¤ºé«˜éŸ³
                    backgroundColor = 'background: linear-gradient(to bottom, #e8f5e8, #c8e6c9); border: 2px solid #4caf50;';
                } else {
                    backgroundColor = 'background: linear-gradient(to bottom, #c8e6c9, #a5d6a7); border: 2px solid #4caf50;';
                }
                
                blankSlot.innerHTML = `
                    <div class="filled-note" data-key-data='${JSON.stringify(keyData)}' draggable="true" style="
                        width: 60px;
                        height: 80px;
                        ${backgroundColor}
                        border-radius: 8px;
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        justify-content: center;
                        font-weight: bold;
                        cursor: pointer;
                        position: relative;
                    ">
                        ${octave === 1 ? '<div style="position: absolute; top: -2px; left: 50%; transform: translateX(-50%); width: 8px; height: 2px; background: #4caf50; border-radius: 1px;"></div>' : ''}
                        <div style="font-size: 16px;">${noteValue}${octaveIndicator}</div>
                        <div style="font-size: 10px; opacity: 0.8;">${keyData.lyric}</div>
                        ${octave === -1 ? '<div style="position: absolute; bottom: -2px; left: 50%; transform: translateX(-50%); width: 8px; height: 2px; background: #f44336; border-radius: 1px;"></div>' : ''}
                    </div>
                `;
                
                // ä¸ºå¡«å……çš„éŸ³ç¬¦æ·»åŠ ç‚¹å‡»å’Œæ‹–æ‹½äº‹ä»¶
                const filledNote = blankSlot.querySelector('.filled-note');
                filledNote.addEventListener('click', () => {
                    this.playNote(keyData.note);
                    filledNote.style.transform = 'scale(0.95)';
                    setTimeout(() => filledNote.style.transform = 'scale(1)', 150);
                });
                this.addDragEventsToFilledNote(filledNote);
            }

            addDragEventsToFilledNote(filledNote) {
                filledNote.addEventListener('dragstart', (e) => {
                    const keyData = JSON.parse(filledNote.dataset.keyData);
                    e.dataTransfer.setData('text/plain', JSON.stringify({
                        ...keyData,
                        isFromBlank: true,
                        sourceBlankPosition: filledNote.closest('.blank-position').dataset.position
                    }));
                    filledNote.classList.add('dragging');
                });

                filledNote.addEventListener('dragend', (e) => {
                    filledNote.classList.remove('dragging');
                });
            }

            returnKeyToPiano(keyData) {
                const originalKey = this.currentKeys[keyData.index];
                if (originalKey) {
                    originalKey.style.opacity = '1';
                    originalKey.style.pointerEvents = 'auto';
                }
            }

            updateFilledPositions() {
                const filledCount = document.querySelectorAll('.filled-note').length;
                const totalBlanks = this.blankPositions.length;
                
                console.log(`å·²å¡«å…… ${filledCount}/${totalBlanks} ä¸ªä½ç½®`);
            }

            resetMelodyDisplay() {
                // é‡ç½®æ‰€æœ‰é’¢ç´é”®çš„çŠ¶æ€
                this.currentKeys.forEach(key => {
                    key.style.opacity = '1';
                    key.style.pointerEvents = 'auto';
                });
                
                // æ¸…é™¤æ‰€æœ‰å·²å¡«å……çš„éŸ³ç¬¦
                document.querySelectorAll('.filled-note').forEach(note => {
                    const blankSlot = note.closest('.blank-position');
                    if (blankSlot) {
                        blankSlot.innerHTML = `
                            <div class="blank-slot" style="
                                width: 60px;
                                height: 80px;
                                border: 3px dashed #ff9800;
                                border-radius: 8px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                background: rgba(255, 152, 0, 0.1);
                                color: #ff9800;
                                font-size: 12px;
                                text-align: center;
                            ">
                                ?<br/>ç©ºç¼º
                            </div>
                        `;
                    }
                });
                
                this.updateFilledPositions();
            }

            checkOrder() {
                // æ£€æŸ¥æ‰€æœ‰ç©ºç¼ºä½ç½®æ˜¯å¦éƒ½å·²æ­£ç¡®å¡«å……
                let allCorrect = true;
                let filledCount = 0;
                const totalBlanks = this.blankPositions.length;
                const wrongPositions = []; // è®°å½•é”™è¯¯çš„ä½ç½®
                
                for (const position of this.blankPositions) {
                    const blankSlot = document.querySelector(`.blank-position[data-position="${position}"]`);
                    const filledNote = blankSlot?.querySelector('.filled-note');
                    
                    if (filledNote) {
                        filledCount++;
                        const keyData = JSON.parse(filledNote.dataset.keyData);
                        const expectedNote = this.currentSong.melody[position];
                        
                        // æ¯”è¾ƒéŸ³ç¬¦ï¼ˆæ”¯æŒé«˜ä½éŸ³æ ¼å¼ï¼‰
                        const actualNote = keyData.note;
                        let isCorrect = false;
                        
                        if (typeof expectedNote === 'object' && typeof actualNote === 'object') {
                            // ä¸¤è€…éƒ½æ˜¯å¯¹è±¡æ ¼å¼
                            isCorrect = expectedNote.note === actualNote.note && expectedNote.octave === actualNote.octave;
                        } else if (typeof expectedNote === 'number' && typeof actualNote === 'number') {
                            // ä¸¤è€…éƒ½æ˜¯æ•°å­—æ ¼å¼
                            isCorrect = expectedNote === actualNote;
                        } else if (typeof expectedNote === 'object' && typeof actualNote === 'number') {
                            // æœŸæœ›æ˜¯å¯¹è±¡ï¼Œå®é™…æ˜¯æ•°å­—ï¼ˆå‘ä¸‹å…¼å®¹ï¼‰
                            isCorrect = expectedNote.note === actualNote && (expectedNote.octave || 0) === 0;
                        } else if (typeof expectedNote === 'number' && typeof actualNote === 'object') {
                            // æœŸæœ›æ˜¯æ•°å­—ï¼Œå®é™…æ˜¯å¯¹è±¡ï¼ˆå‘ä¸‹å…¼å®¹ï¼‰
                            isCorrect = expectedNote === actualNote.note && (actualNote.octave || 0) === 0;
                        }
                        
                        if (!isCorrect) {
                            allCorrect = false;
                            wrongPositions.push({ position, blankSlot, filledNote, keyData });
                            console.log(`ä½ç½® ${position} é”™è¯¯: æœŸæœ› ${JSON.stringify(expectedNote)}, å®é™… ${JSON.stringify(actualNote)}`);
                        }
                    } else {
                        allCorrect = false;
                        console.log(`ä½ç½® ${position} æœªå¡«å……`);
                    }
                }
                
                console.log(`å¡«å……è¿›åº¦: ${filledCount}/${totalBlanks}`);
                console.log('æ˜¯å¦å…¨éƒ¨æ­£ç¡®:', allCorrect);
                
                if (filledCount < totalBlanks) {
                    alert(`è¿˜æœ‰ ${totalBlanks - filledCount} ä¸ªç©ºç¼ºä½ç½®æœªå¡«å……ï¼Œè¯·ç»§ç»­å¡«è¡¥ï¼`);
                } else if (!allCorrect) {
                    // è‡ªåŠ¨å°†é”™è¯¯çš„éŸ³ç¬¦æ”¾å›åŸä½
                    let returnedCount = 0;
                    wrongPositions.forEach(({ blankSlot, filledNote, keyData }) => {
                        // å°†éŸ³ç¬¦æ”¾å›é’¢ç´é”®åŒºåŸŸ
                        this.returnKeyToPiano(keyData);
                        
                        // ç§»é™¤å¡«å……çš„éŸ³ç¬¦
                        filledNote.remove();
                        
                        // æ¸…ç©ºç©ºç¼ºä½ç½®
                        this.clearBlankPosition(blankSlot);
                        
                        returnedCount++;
                    });
                    
                    // æ›´æ–°å¡«å……çŠ¶æ€
                    this.updateFilledPositions();
                    
                    alert(`æ£€æµ‹åˆ° ${wrongPositions.length} ä¸ªéŸ³ç¬¦å¡«é”™äº†ä½ç½®ï¼Œå·²è‡ªåŠ¨æ”¾å›åŸä½ï¼\n\nğŸ’¡ æç¤ºï¼šç‚¹å‡»"æç¤º"æŒ‰é’®å¯ä»¥å¬åˆ°æ­£ç¡®çš„æ—‹å¾‹`);
                } else {
                    // å…¨éƒ¨æ­£ç¡®
                    this.showCelebration();
                    
                    if (this.currentLevel === this.maxLevel) {
                        this.completeGame();
                    } else {
                        this.completeLevel();
                    }
                }
            }

            showCelebration() {
                const celebration = document.getElementById('celebration');
                celebration.style.display = 'block';
                setTimeout(() => {
                    celebration.style.display = 'none';
                }, 2000);
            }

            completeLevel() {
                setTimeout(() => {
                    document.getElementById('level-complete-modal').style.display = 'flex';
                }, 1000);
            }

            nextLevel() {
                document.getElementById('level-complete-modal').style.display = 'none';
                this.currentLevel++;
                this.generateLevel();
            }

            completeGame() {
                this.gameRunning = false;
                const totalTime = Date.now() - this.startTime;
                const timeString = this.formatTime(totalTime);
                
                document.getElementById('final-time').textContent = timeString;
                this.updateLeaderboard(timeString);
                
                setTimeout(() => {
                    document.getElementById('game-complete-modal').style.display = 'flex';
                }, 1000);
            }

            updateLeaderboard(newTime) {
                let scores = JSON.parse(localStorage.getItem('pianoSortScores') || '[]');
                scores.push({
                    time: newTime,
                    timestamp: new Date().toLocaleString()
                });
                
                // æŒ‰æ—¶é—´æ’åºï¼ˆè½¬æ¢ä¸ºæ¯«ç§’è¿›è¡Œæ¯”è¾ƒï¼‰
                scores.sort((a, b) => {
                    const timeA = this.timeStringToMs(a.time);
                    const timeB = this.timeStringToMs(b.time);
                    return timeA - timeB;
                });
                
                // åªä¿ç•™å‰10å
                scores = scores.slice(0, 10);
                localStorage.setItem('pianoSortScores', JSON.stringify(scores));
                
                this.displayLeaderboard(scores);
            }

            timeStringToMs(timeString) {
                const [minutes, seconds] = timeString.split(':').map(Number);
                return minutes * 60000 + seconds * 1000;
            }

            displayLeaderboard(scores) {
                const leaderboard = document.getElementById('leaderboard');
                leaderboard.innerHTML = '<h3>æ’è¡Œæ¦œ:</h3>';
                
                scores.forEach((score, index) => {
                    const item = document.createElement('div');
                    item.className = 'leaderboard-item';
                    item.innerHTML = `
                        <span>${index + 1}. ${score.time}</span>
                        <span>${score.timestamp}</span>
                    `;
                    leaderboard.appendChild(item);
                });
            }

            updateTimer() {
                if (!this.gameRunning) return;
                
                const elapsed = Date.now() - this.startTime;
                const timeString = this.formatTime(elapsed);
                document.getElementById('timer').textContent = timeString;
                
                setTimeout(() => this.updateTimer(), 100);
            }

            formatTime(ms) {
                const seconds = Math.floor(ms / 1000);
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
            }
        }

        // å…¨å±€å‡½æ•°
        function startNewGame() {
            document.getElementById('game-complete-modal').style.display = 'none';
            new PianoSortGame();
        }

        function nextLevel() {
            window.game.nextLevel();
        }

        // å¯åŠ¨æ¸¸æˆ
        window.addEventListener('load', () => {
            window.game = new PianoSortGame();
        });
    </script>
</body>
</html>