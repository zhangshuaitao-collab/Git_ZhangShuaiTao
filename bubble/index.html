<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>气泡谜题</title>
    <style>
      :root {
        color-scheme: light;
        --bg: #0f172a;
        --panel: #111827;
        --accent: #38bdf8;
        --accent-2: #a78bfa;
        --danger: #f97316;
        --text: #e2e8f0;
        --muted: #94a3b8;
        --success: #10b981;
        --bubble: #60a5fa;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: "Segoe UI", "PingFang SC", "Microsoft YaHei", sans-serif;
        background: radial-gradient(circle at top, #1e293b, #0f172a 55%, #020617 100%);
        color: var(--text);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 24px;
      }
      .app {
        width: min(980px, 100%);
        background: var(--panel);
        border-radius: 18px;
        padding: 24px;
        box-shadow: 0 25px 60px rgba(2, 6, 23, 0.6);
      }
      header {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 20px;
      }
      h1 {
        margin: 0;
        font-size: 24px;
        letter-spacing: 1px;
      }
      .status {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
      }
      .pill {
        background: #1f2937;
        border-radius: 999px;
        padding: 6px 14px;
        font-size: 14px;
        color: var(--muted);
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .pill strong {
        color: var(--text);
        font-weight: 600;
      }
      .level-wrapper {
        display: grid;
        gap: 20px;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      }
      .tips,
      .controls,
      .board {
        background: #0b1120;
        border-radius: 14px;
        padding: 18px;
        border: 1px solid rgba(148, 163, 184, 0.2);
      }
      .tips h2,
      .board h2,
      .controls h2 {
        margin-top: 0;
        font-size: 18px;
      }
      .tips ul {
        margin: 0;
        padding-left: 20px;
        color: var(--muted);
        line-height: 1.6;
      }
      .board {
        min-height: 280px;
      }
      .bubble-grid {
        display: grid;
        gap: 16px;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        margin-top: 12px;
      }
      .bubble-card {
        background: rgba(56, 189, 248, 0.12);
        border-radius: 16px;
        padding: 12px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
        border: 1px solid rgba(56, 189, 248, 0.3);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }
      .bubble-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 18px rgba(56, 189, 248, 0.15);
      }
      .bubble {
        width: 90px;
        height: 90px;
        border-radius: 50%;
        background: radial-gradient(circle at 30% 30%, #e0f2fe, var(--bubble));
        position: relative;
        display: grid;
        place-items: center;
        color: #0f172a;
        font-weight: 700;
      }
      .bubble::after {
        content: "";
        position: absolute;
        inset: 10px;
        border-radius: 50%;
        border: 2px dashed rgba(255, 255, 255, 0.4);
      }
      .bubble-card button {
        width: 100%;
        border: none;
        border-radius: 999px;
        padding: 8px 12px;
        background: var(--accent);
        color: #0f172a;
        font-weight: 600;
        cursor: pointer;
        transition: filter 0.2s ease;
      }
      .bubble-card button:disabled {
        cursor: not-allowed;
        filter: grayscale(0.6);
        background: #64748b;
        color: #e2e8f0;
      }
      .bubble-card.lit {
        border-color: rgba(251, 191, 36, 0.6);
        box-shadow: 0 10px 18px rgba(251, 191, 36, 0.15);
      }
      .bubble-card.lit .bubble {
        background: radial-gradient(circle at 30% 30%, #fef3c7, #f59e0b);
        color: #1f2937;
      }
      .bubble-meta {
        font-size: 13px;
        color: var(--muted);
        text-align: center;
      }
      .controls {
        display: grid;
        gap: 12px;
      }
      .controls button {
        border: none;
        border-radius: 10px;
        padding: 10px 12px;
        font-weight: 600;
        cursor: pointer;
        color: #0f172a;
        background: var(--accent-2);
      }
      .controls button.secondary {
        background: transparent;
        color: var(--text);
        border: 1px solid rgba(148, 163, 184, 0.4);
      }
      .message {
        margin-top: 14px;
        padding: 12px;
        border-radius: 12px;
        background: rgba(148, 163, 184, 0.12);
        color: var(--muted);
        min-height: 48px;
      }
      .message.success {
        color: #d1fae5;
        background: rgba(16, 185, 129, 0.2);
      }
      .message.fail {
        color: #fed7aa;
        background: rgba(249, 115, 22, 0.2);
      }
      .legend {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        font-size: 13px;
        color: var(--muted);
      }
      .legend span {
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }
      .dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: var(--accent);
      }
      .dot.warning {
        background: var(--danger);
      }
      footer {
        margin-top: 20px;
        font-size: 12px;
        color: var(--muted);
        text-align: center;
      }
      .modal {
        position: fixed;
        inset: 0;
        background: rgba(2, 6, 23, 0.6);
        display: grid;
        place-items: center;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease;
      }
      .modal.show {
        opacity: 1;
        pointer-events: auto;
      }
      .modal-card {
        width: min(420px, 90vw);
        background: #0b1120;
        border-radius: 16px;
        padding: 20px;
        border: 1px solid rgba(148, 163, 184, 0.3);
        box-shadow: 0 20px 40px rgba(2, 6, 23, 0.5);
        text-align: center;
        position: relative;
        overflow: hidden;
      }
      .modal-card h3 {
        margin: 0 0 10px;
        font-size: 20px;
      }
      .modal-card p {
        margin: 0 0 16px;
        color: var(--muted);
      }
      .modal-card button {
        border: none;
        border-radius: 10px;
        padding: 10px 18px;
        font-weight: 600;
        cursor: pointer;
        color: #0f172a;
        background: var(--accent);
      }
    </style>
  </head>
  <body>
    <div class="app">
      <header>
        <h1>气泡谜题：暗示与呼吸</h1>
        <div class="status">
          <div class="pill">
            当前关卡 <strong id="level-index">1</strong>
          </div>
          <div class="pill">
            剩余充气次数 <strong id="remaining-pumps">0</strong>
          </div>
          <div class="pill">
            已充气次数 <strong id="used-pumps">0</strong>
          </div>
        </div>
      </header>

      <div class="level-wrapper">
        <section class="tips">
          <h2>提示语</h2>
          <ul id="tips-list"></ul>
          <div class="message" id="message">根据提示推理每个泡泡的可点击次数。</div>
        </section>

        <section class="board">
          <h2>泡泡区</h2>
          <div class="legend">
            <span><span class="dot"></span> 充气一次</span>
            <span><span class="dot warning"></span> 超出次数会破碎</span>
          </div>
          <div class="bubble-grid" id="bubble-grid"></div>
        </section>

        <section class="controls">
          <h2>操作</h2>
          <button id="reset-level">重置当前关卡</button>
          <button id="next-level" class="secondary" disabled>进入下一关</button>
          <button id="restart" class="secondary">重新开始</button>
        </section>
      </div>

      <footer>
        规则：完成所有充气次数且没有泡泡破碎即胜利。提示不会直说答案，需要推理。
      </footer>
    </div>

    <div class="modal" id="modal" aria-hidden="true">
      <div class="modal-card" role="dialog" aria-modal="true">
        <h3 id="modal-title">提示</h3>
        <p id="modal-text">内容</p>
        <button id="modal-ok">确定</button>
      </div>
    </div>

    <script>
      const levels = [
        {
          title: "第一关：门口的风铃",
          mode: "limit",
          totalPumps: 8,
          bubbles: [
            { id: "A", limit: 1 },
            { id: "B", limit: 2 },
            { id: "C", limit: 5 },
          ],
          tips: [
            "每个泡泡都有自己的“脾气”，但它们都愿意被点一次以上才开口。",
            "编号靠前的泡泡害怕被过度关注。",
            "剩下的那个泡泡能多陪你一会儿。",
          ],
        },
        {
          title: "第二关：纸灯的影子",
          mode: "limit",
          totalPumps: 11,
          bubbles: [
            { id: "A", limit: 4 },
            { id: "B", limit: 3 },
            { id: "C", limit: 2 },
            { id: "D", limit: 2 },
          ],
          tips: [
            "四个泡泡的耐心从多到少只差一步。",
            "如果你让两个泡泡的次数一样，记得它们站在末尾。",
          ],
        },
        {
          title: "第三关：航海日记",
          mode: "limit",
          totalPumps: 14,
          bubbles: [
            { id: "A", limit: 3 },
            { id: "B", limit: 5 },
            { id: "C", limit: 4 },
            { id: "D", limit: 2 },
            { id: "E", limit: 0 },
          ],
          tips: [
            "船长不喜欢空洞的承诺，但船舱里有一个永远不会回应。",
            "从左到右耐心不是单调的。",
            "总气量会让你无法忽视那个沉默的泡泡。",
            "两位中间泡泡的差距只有一次呼吸。",
          ],
        },
        {
          title: "第四关：星光序列",
          mode: "sequence",
          bubbles: [{ id: "A" }, { id: "B" }, { id: "C" }],
          sequence: ["B", "A", "C"],
          tips: [
            "按照顺序点亮泡泡。",
            "第一道光不在两端。",
          ],
        },
        {
          title: "第五关：回声走廊",
          mode: "sequence",
          bubbles: [{ id: "A" }, { id: "B" }, { id: "C" }, { id: "D" }],
          sequence: ["C", "A", "D", "B"],
          tips: [
            "最先亮起的在字母序里并不最前。",
            "第二步与第四步位置相隔最远。",
            "中间那一束光来自最靠前的泡泡。",
          ],
        },
        {
          title: "第六关：静默的阶梯",
          mode: "sequence",
          bubbles: [
            { id: "A" },
            { id: "B" },
            { id: "C" },
            { id: "D" },
            { id: "E" },
          ],
          sequence: ["D", "B", "E", "A", "C"],
          tips: [
            "第一步不是 A，也不是 B。",
            "最末尾的那一下来自字母序中间者。",
            "第二步与第四步都在两端之外。",
          ],
        },
      ];

      const state = {
        levelIndex: 0,
        usedPumps: 0,
        remainingPumps: 0,
        isOver: false,
        mode: "limit",
        sequenceProgress: 0,
      };

      const levelIndexEl = document.getElementById("level-index");
      const remainingEl = document.getElementById("remaining-pumps");
      const usedEl = document.getElementById("used-pumps");
      const tipsListEl = document.getElementById("tips-list");
      const bubbleGridEl = document.getElementById("bubble-grid");
      const messageEl = document.getElementById("message");
      const nextLevelBtn = document.getElementById("next-level");
      const resetLevelBtn = document.getElementById("reset-level");
      const restartBtn = document.getElementById("restart");
      const modalEl = document.getElementById("modal");
      const modalTitleEl = document.getElementById("modal-title");
      const modalTextEl = document.getElementById("modal-text");
      const modalOkBtn = document.getElementById("modal-ok");

      const modalState = {
        onConfirm: null,
      };

      const formatMessage = (text, type = "") => {
        messageEl.textContent = text;
        messageEl.className = `message ${type}`;
      };

      const openModal = (title, text, onConfirm) => {
        modalTitleEl.textContent = title;
        modalTextEl.textContent = text;
        modalState.onConfirm = onConfirm;
        modalEl.classList.add("show");
        modalEl.setAttribute("aria-hidden", "false");
      };

      const closeModal = () => {
        modalEl.classList.remove("show");
        modalEl.setAttribute("aria-hidden", "true");
        modalState.onConfirm = null;
      };

      const loadLevel = (index) => {
        const level = levels[index];
        state.levelIndex = index;
        state.mode = level.mode || "limit";
        state.sequenceProgress = 0;
        state.usedPumps = 0;
        state.remainingPumps = level.totalPumps || 0;
        state.isOver = false;

        levelIndexEl.textContent = index + 1;
        remainingEl.textContent = state.remainingPumps;
        usedEl.textContent = state.usedPumps;

        tipsListEl.innerHTML = "";
        level.tips.forEach((tip) => {
          const li = document.createElement("li");
          li.textContent = tip;
          tipsListEl.appendChild(li);
        });

        bubbleGridEl.innerHTML = "";
        level.bubbles.forEach((bubble, bubbleIndex) => {
          const card = document.createElement("div");
          card.className = "bubble-card";
          card.dataset.id = bubble.id;
          card.dataset.limit = bubble.limit ?? "";
          card.dataset.count = "0";

          const bubbleEl = document.createElement("div");
          bubbleEl.className = "bubble";
          bubbleEl.textContent = bubble.id;

          const button = document.createElement("button");
          button.textContent = state.mode === "sequence" ? "点亮" : "充气";
          button.addEventListener("click", () =>
            state.mode === "sequence"
              ? handleSequence(card, bubble, level)
              : handlePump(card, bubble)
          );

          const meta = document.createElement("div");
          meta.className = "bubble-meta";
          meta.textContent =
            state.mode === "sequence" ? "等待点亮" : "已充气 0 次";

          card.appendChild(bubbleEl);
          card.appendChild(button);
          card.appendChild(meta);
          bubbleGridEl.appendChild(card);

          void bubbleIndex;
        });

        nextLevelBtn.disabled = true;
        formatMessage(
          state.mode === "sequence"
            ? `${level.title}：请按顺序点亮泡泡。`
            : `${level.title}：请分配你的充气次数。`
        );
      };

      const handlePump = (card, bubble) => {
        if (state.isOver) return;
        if (modalEl.classList.contains("show")) return;
        if (state.mode !== "limit") return;
        if (state.remainingPumps <= 0) {
          formatMessage("已经没有剩余次数了，检查是否所有泡泡都满足条件。", "");
          return;
        }

        const currentCount = Number(card.dataset.count);
        const nextCount = currentCount + 1;
        const limit = bubble.limit;

        if (nextCount > limit) {
          state.isOver = true;
          card.querySelector("button").disabled = true;
          card.classList.add("broken");
          disableAllButtons();
          openModal("失败", "泡泡破碎！有一个被点过头了。", () =>
            loadLevel(state.levelIndex)
          );
          return;
        }

        card.dataset.count = String(nextCount);
        state.usedPumps += 1;
        state.remainingPumps -= 1;

        updateStats();
        updateCard(card, nextCount, limit);
        checkWin();
      };

      const updateCard = (card, count) => {
        const meta = card.querySelector(".bubble-meta");
        meta.textContent = `已充气 ${count} 次`;
      };

      const resetSequence = () => {
        state.sequenceProgress = 0;
        bubbleGridEl.querySelectorAll(".bubble-card").forEach((card) => {
          card.classList.remove("lit");
          card.querySelector(".bubble-meta").textContent = "等待点亮";
          card.querySelector("button").disabled = false;
        });
      };

      const handleSequence = (card, bubble, level) => {
        if (state.isOver) return;
        if (modalEl.classList.contains("show")) return;
        const expectedId = level.sequence[state.sequenceProgress];
        if (bubble.id !== expectedId) {
          resetSequence();
          formatMessage("顺序错误，重新开始。", "fail");
          return;
        }

        card.classList.add("lit");
        card.querySelector("button").disabled = true;
        card.querySelector(".bubble-meta").textContent = "已点亮";
        state.sequenceProgress += 1;

        if (state.sequenceProgress >= level.sequence.length) {
          state.isOver = true;
          disableAllButtons();
          formatMessage("成功！顺序被正确点亮。", "success");
          nextLevelBtn.disabled = state.levelIndex >= levels.length - 1;
          openModal("过关", "恭喜过关", () => {
            if (state.levelIndex < levels.length - 1) {
              loadLevel(state.levelIndex + 1);
            } else {
              loadLevel(0);
            }
          });
        }
      };

      const updateStats = () => {
        remainingEl.textContent = state.remainingPumps;
        usedEl.textContent = state.usedPumps;
      };

      const disableAllButtons = () => {
        bubbleGridEl.querySelectorAll("button").forEach((btn) => {
          btn.disabled = true;
        });
      };

      const checkWin = () => {
        if (state.mode !== "limit") return;
        if (state.remainingPumps !== 0) return;
        const allSafe = [...bubbleGridEl.children].every((card) => {
          const limit = Number(card.dataset.limit);
          const count = Number(card.dataset.count);
          return count === limit;
        });
        if (allSafe) {
          state.isOver = true;
          disableAllButtons();
          formatMessage("成功！所有泡泡都被恰好安抚。", "success");
          nextLevelBtn.disabled = state.levelIndex >= levels.length - 1;
          const rewardMessages = [
            "恭喜过关，奖励一张法拉利五块钱优惠券",
            "恭喜过关，奖励一片高富帅/白富美碎片，两亿个碎片兑换",
            "恭喜过关，触发特殊事件，奖励列表清空",
          ];
          const rewardText =
            rewardMessages[state.levelIndex] || "恭喜通关，准备进入下一关。";
          openModal("过关", rewardText, () => {
            if (state.levelIndex < levels.length - 1) {
              loadLevel(state.levelIndex + 1);
            } else {
              loadLevel(0);
            }
          });
        } else {
          state.isOver = true;
          disableAllButtons();
          openModal("失败", "次数用完但还有泡泡未达到极限。", () =>
            loadLevel(state.levelIndex)
          );
        }
      };

      resetLevelBtn.addEventListener("click", () => loadLevel(state.levelIndex));
      restartBtn.addEventListener("click", () => loadLevel(0));
      nextLevelBtn.addEventListener("click", () => {
        if (state.levelIndex < levels.length - 1) {
          loadLevel(state.levelIndex + 1);
        }
      });
      modalOkBtn.addEventListener("click", () => {
        const onConfirm = modalState.onConfirm;
        closeModal();
        if (typeof onConfirm === "function") {
          onConfirm();
        }
      });

      loadLevel(0);
    </script>
  </body>
</html>

